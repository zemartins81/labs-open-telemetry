# Sistema de Temperatura por CEP com OpenTelemetry

Sistema distribuÃ­do em Go composto por dois microserviÃ§os que fornecem informaÃ§Ãµes de temperatura baseadas em CEP brasileiro, integrado com OpenTelemetry e Zipkin para observabilidade.

## ğŸ“‹ VisÃ£o Geral

- **ServiÃ§o A** (8080): Recebe e valida CEPs, encaminha para o ServiÃ§o B
- **ServiÃ§o B** (8081): Busca localizaÃ§Ã£o (ViaCEP) e temperatura (WeatherAPI)
- **Zipkin** (9411): Interface de observabilidade para traces distribuÃ­dos

## ğŸ—ï¸ Arquitetura

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    HTTP POST     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â”‚   /cep/{cep}     â”‚             â”‚
â”‚  ServiÃ§o A  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  ServiÃ§o B  â”‚
â”‚   (8080)    â”‚                  â”‚   (8081)    â”‚
â”‚             â”‚                  â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                â”‚
       â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                      â”‚                   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   APIs Externas   â”‚
              OpenTelemetry    â”‚                   â”‚
              Traces           â”‚ ViaCEP + Weather  â”‚
              â–¼                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         â”‚
â”‚    Zipkin (9411)        â”‚
â”‚   Trace Visualization   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ InÃ­cio RÃ¡pido

### PrÃ©-requisitos

1. **Docker & Docker Compose** (obrigatÃ³rio)
2. **Chave WeatherAPI** (gratuita)
3. **Go 1.24+** (opcional, para desenvolvimento local)

### 1. Clone o RepositÃ³rio

```bash
git clone https://github.com/zemartins81/labs-open-telemetry.git
cd labs-open-telemetry/sistema-cep
```

### 2. Obter Chave da WeatherAPI

1. Acesse [WeatherAPI.com](https://www.weatherapi.com/)
2. Crie uma conta gratuita
3. VÃ¡ em "My Account" â†’ "API Keys"
4. Copie sua chave

### 3. Configurar Ambiente

```bash
# Copie o arquivo de exemplo
cp .env.example .env

# Edite o arquivo .env e adicione sua chave
# WEATHER_API_KEY=sua_chave_weatherapi_aqui
```

### 4. Executar com Docker Compose

```bash
# Subir todos os serviÃ§os (microserviÃ§os + Zipkin)
docker compose up --build

# Em background (recomendado)
docker compose up --build -d
```

### 5. Verificar se os ServiÃ§os EstÃ£o Funcionando

```bash
# Verificar status dos containers
docker compose ps

# Health checks
curl http://localhost:8080/health  # ServiÃ§o A
curl http://localhost:8081/health  # ServiÃ§o B
curl http://localhost:9411/health  # Zipkin
```

### 6. Testar o Sistema

```bash
# Teste com CEP vÃ¡lido (Av. Paulista - SÃ£o Paulo)
curl -X POST http://localhost:8080 \
  -H "Content-Type: application/json" \
  -d '{"cep": "01310100"}'

# Resposta esperada:
# {
#   "city": "San Paulo",
#   "temp_C": 23.1,
#   "temp_F": 73.6,
#   "temp_K": 296.25
# }
```

### 7. Acessar Interface de Observabilidade

- **Zipkin**: [http://localhost:9411](http://localhost:9411)
  - Visualize traces distribuÃ­dos entre os serviÃ§os
  - Analise latÃªncia e performance das chamadas

## ğŸ“ Estrutura do Projeto

```text
labs-open-telemetry/
â”œâ”€â”€ sistema-cep/
â”‚   â”œâ”€â”€ servico-a/                  # MicroserviÃ§o A (validaÃ§Ã£o e roteamento)
â”‚   â”‚   â”œâ”€â”€ cmd/main.go
â”‚   â”‚   â”œâ”€â”€ internal/
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â”œâ”€â”€ makefile
â”‚   â”‚   â””â”€â”€ README.md
â”‚   â”œâ”€â”€ servico-b/                  # MicroserviÃ§o B (orquestraÃ§Ã£o de APIs)
â”‚   â”‚   â”œâ”€â”€ cmd/main.go
â”‚   â”‚   â”œâ”€â”€ internal/
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â”œâ”€â”€ makefile
â”‚   â”‚   â””â”€â”€ README.md
â”‚   â”œâ”€â”€ docker-compose.yml          # OrquestraÃ§Ã£o dos serviÃ§os
â”‚   â”œâ”€â”€ .env.example               # Exemplo de configuraÃ§Ã£o
â”‚   â””â”€â”€ .env                       # ConfiguraÃ§Ã£o local (criar)
â””â”€â”€ README.md                      # Esta documentaÃ§Ã£o
```

## ğŸ”§ Desenvolvimento Local

### Executar ServiÃ§os Individualmente

```bash
# Terminal 1 - ServiÃ§o B (precisa executar primeiro)
cd servico-b
WEATHER_API_KEY=sua_chave make run

# Terminal 2 - ServiÃ§o A
cd servico-a
make run

# Terminal 3 - Zipkin (opcional para desenvolvimento)
docker run -d -p 9411:9411 openzipkin/zipkin
```

### Executar Testes

```bash
# ServiÃ§o A
cd servico-a && make test

# ServiÃ§o B
cd servico-b && make test

# Teste funcional completo (requer serviÃ§os rodando)
make test-integration
```

## ğŸ“¡ Endpoints da API

### ServiÃ§o A (Porta 8080)

#### `POST /`

Recebe CEP e retorna temperatura

**Request:**

```json
{
  "cep": "01310100"
}
```

**Response Success (200):**

```json
{
  "city": "San Paulo",
  "temp_C": 23.1,
  "temp_F": 73.6,
  "temp_K": 296.25
}
```

**Response Error (422):**

```json
{
  "message": "invalid zipcode"
}
```

#### `GET /health`

Health check do ServiÃ§o A

### ServiÃ§o B (Porta 8081)

#### `POST /temperature`

Processa CEP e busca temperatura (uso interno)

#### `GET /health`

Health check do ServiÃ§o B

### Zipkin (Porta 9411)

#### Interface Web

- **URL**: [http://localhost:9411](http://localhost:9411)
- **FunÃ§Ã£o**: VisualizaÃ§Ã£o de traces distribuÃ­dos
- **Uso**: AnÃ¡lise de performance e debugging

## ğŸ§ª Casos de Teste

```bash
# CEP vÃ¡lido
curl -X POST http://localhost:8080 \
  -H "Content-Type: application/json" \
  -d '{"cep": "01310100"}'

# CEP invÃ¡lido (formato)
curl -X POST http://localhost:8080 \
  -H "Content-Type: application/json" \
  -d '{"cep": "123"}'

# CEP nÃ£o encontrado
curl -X POST http://localhost:8080 \
  -H "Content-Type: application/json" \
  -d '{"cep": "99999999"}'

# Health checks
curl http://localhost:8080/health
curl http://localhost:8081/health
```

## ğŸ” CÃ³digos de Resposta

| CÃ³digo | DescriÃ§Ã£o |
|--------|-----------|
| 200    | Sucesso - temperatura encontrada |
| 400    | Bad Request - JSON malformado |
| 404    | CEP nÃ£o encontrado |
| 405    | MÃ©todo nÃ£o permitido |
| 422    | CEP com formato invÃ¡lido |
| 500    | Erro interno do servidor |

## ğŸŒ¡ï¸ ConversÃµes de Temperatura

- **Celsius**: Valor original da WeatherAPI
- **Fahrenheit**: F = C Ã— 1.8 + 32
- **Kelvin**: K = C + 273.15

## ğŸ› ï¸ Comandos Ãšteis

```bash
# Parar todos os serviÃ§os
docker compose down

# Rebuild completo (limpa cache)
docker compose down
docker compose build --no-cache
docker compose up

# Ver logs em tempo real
docker compose logs -f servico-a
docker compose logs -f servico-b
docker compose logs -f zipkin

# Ver logs de todos os serviÃ§os
docker compose logs -f

# Escalar serviÃ§os (para testes de carga)
docker compose up --scale servico-a=2 --scale servico-b=2
```

## ğŸ”§ ConfiguraÃ§Ã£o AvanÃ§ada

### VariÃ¡veis de Ambiente

| VariÃ¡vel | ServiÃ§o | DescriÃ§Ã£o | PadrÃ£o | ObrigatÃ³ria |
|----------|---------|-----------|--------|-------------|
| `WEATHER_API_KEY` | B | Chave WeatherAPI | - | âœ… Sim |
| `SERVICE_B_URL` | A | URL do ServiÃ§o B | `http://servico-b:8081` | NÃ£o |
| `VIACEP_URL` | B | URL da ViaCEP | `https://viacep.com.br/ws` | NÃ£o |
| `WEATHER_API_URL` | B | URL da WeatherAPI | `http://api.weatherapi.com/v1` | NÃ£o |
| `ZIPKIN_ENDPOINT` | A, B | URL do Zipkin | `http://zipkin:9411/api/v2/spans` | NÃ£o |
| `PORT` | A, B | Porta do serviÃ§o | `8080`/`8081` | NÃ£o |

### Portas Customizadas

Para alterar as portas, crie um arquivo `docker-compose.override.yml`:

```yaml
version: '3.8'
services:
  servico-a:
    ports:
      - "9000:8080"
  servico-b:
    ports:
      - "9001:8081"
  zipkin:
    ports:
      - "9412:9411"
```

## ğŸ› Troubleshooting

### âŒ Erro: "WEATHER_API_KEY Ã© obrigatÃ³ria"

**SoluÃ§Ã£o:**

1. Verifique se a chave estÃ¡ no arquivo `.env`
2. Confirme se a chave Ã© vÃ¡lida no [WeatherAPI.com](https://www.weatherapi.com/)
3. Reinicie os containers: `docker compose restart`

### âŒ Erro: "can not find zipcode"

**Problema:** CEP pode nÃ£o existir na base ViaCEP

**SoluÃ§Ã£o:**

- Teste com CEPs conhecidos:
  - `01310100` (Av. Paulista, SÃ£o Paulo)
  - `20040020` (Centro, Rio de Janeiro)
  - `40070110` (Pelourinho, Salvador)

### âŒ ServiÃ§os nÃ£o se comunicam

**VerificaÃ§Ãµes:**

1. Todos os containers estÃ£o rodando: `docker compose ps`
2. Containers estÃ£o na mesma rede Docker
3. URLs de comunicaÃ§Ã£o estÃ£o corretas no docker-compose.yml

### âŒ Zipkin nÃ£o mostra traces

**PossÃ­veis causas:**

1. VariÃ¡vel `ZIPKIN_ENDPOINT` incorreta
2. Zipkin nÃ£o estÃ¡ rodando: `curl http://localhost:9411/health`
3. Firewall bloqueando comunicaÃ§Ã£o

## ğŸ“Š Observabilidade

### AnÃ¡lise de Traces no Zipkin

1. **Acesse**: [http://localhost:9411](http://localhost:9411)
2. **FaÃ§a algumas requisiÃ§Ãµes**:

   ```bash
   curl -X POST http://localhost:8080 -H "Content-Type: application/json" -d '{"cep": "01310100"}'
   ```

3. **No Zipkin**:
   - Clique em "Run Query" para ver traces
   - Analise a latÃªncia entre serviÃ§os
   - Identifique gargalos de performance

### MÃ©tricas DisponÃ­veis

- **Tempo de resposta** por serviÃ§o
- **LatÃªncia de rede** entre microserviÃ§os
- **Tempo de resposta das APIs externas** (ViaCEP, WeatherAPI)
- **Traces de erro** para debugging

## ğŸ“š PrÃ³ximos Passos

- [ ] **Metrics**: ImplementaÃ§Ã£o Prometheus + Grafana
- [ ] **Logging**: Structured logs com ELK Stack
- [ ] **Cache**: Redis para cache de respostas ViaCEP
- [ ] **Rate Limiting**: Controle de taxa de requisiÃ§Ãµes
- [ ] **Circuit Breaker**: ProteÃ§Ã£o contra falhas em cascata
- [ ] **Health Checks**: Checks mais robustos com dependÃªncias
- [ ] **Load Testing**: Testes de carga automatizados

## ğŸ¤ ContribuiÃ§Ã£o

1. Fork o projeto
2. Crie uma branch para sua feature: `git checkout -b feature/nova-funcionalidade`
3. Commit suas mudanÃ§as: `git commit -m 'Add nova funcionalidade'`
4. Push para a branch: `git push origin feature/nova-funcionalidade`
5. Abra um Pull Request

## ğŸ“„ LicenÃ§a

Este projeto estÃ¡ sob a licenÃ§a MIT. Veja o arquivo [LICENSE](LICENSE) para mais detalhes.

## ğŸ› Troubleshooting

### Erro: "WEATHER_API_KEY Ã© obrigatÃ³ria"

- Verifique se a chave estÃ¡ no arquivo `.env`
- Confirme se a chave Ã© vÃ¡lida no WeatherAPI

### Erro: "can not find zipcode"

- CEP pode nÃ£o existir na base ViaCEP
- Teste com CEPs conhecidos (01310100, 20040020)

### ServiÃ§os nÃ£o se comunicam

- Verifique se estÃ£o na mesma rede Docker
- Confirme URLs de comunicaÃ§Ã£o entre serviÃ§os

## ğŸ“š PrÃ³ximos Passos

- [ ] ImplementaÃ§Ã£o OpenTelemetry
- [ ] IntegraÃ§Ã£o Zipkin
- [ ] MÃ©tricas Prometheus
- [ ] Cache Redis
- [ ] Rate Limiting
- [ ] Circuit Breaker

## ğŸ¤ ContribuiÃ§Ã£o

1. Fork o projeto
2. Crie uma branch para sua feature
3. Implemente testes
4. Submeta um Pull Request

## ğŸ“„ LicenÃ§a

Este projeto estÃ¡ sob a licenÃ§a MIT.
